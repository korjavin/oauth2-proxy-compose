version: '3.8'

services:
  oauth2-proxy:
    image: ${OAUTH2_PROXY_IMAGE:-quay.io/oauth2-proxy/oauth2-proxy:latest}
    container_name: ${CONTAINER_NAME:-oauth2-proxy}
    restart: unless-stopped
    networks:
      - proxy-network
    environment:
      # --- OIDC Provider Config ---
      OAUTH2_PROXY_PROVIDER: "${OAUTH2_PROXY_PROVIDER}"
      OAUTH2_PROXY_OIDC_ISSUER_URL: "${OAUTH2_PROXY_OIDC_ISSUER_URL}"
      OAUTH2_PROXY_INSECURE_OIDC_ALLOW_UNVERIFIED_EMAIL: "${OAUTH2_PROXY_INSECURE_OIDC_ALLOW_UNVERIFIED_EMAIL:-false}"

      # --- Client Credentials ---
      OAUTH2_PROXY_CLIENT_ID: "${OAUTH2_PROXY_CLIENT_ID}"
      OAUTH2_PROXY_CLIENT_SECRET: "${OAUTH2_PROXY_CLIENT_SECRET}"

      # --- Session & Cookie Config ---
      OAUTH2_PROXY_COOKIE_SECRET: "${OAUTH2_PROXY_COOKIE_SECRET}"
      OAUTH2_PROXY_COOKIE_DOMAIN: "${OAUTH2_PROXY_COOKIE_DOMAIN}"
      OAUTH2_PROXY_COOKIE_SECURE: "${OAUTH2_PROXY_COOKIE_SECURE:-true}"
      OAUTH2_PROXY_COOKIE_SAMESITE: "${OAUTH2_PROXY_COOKIE_SAMESITE:-lax}"

      # --- Proxy Config ---
      OAUTH2_PROXY_HTTP_ADDRESS: "${OAUTH2_PROXY_HTTP_ADDRESS:-0.0.0.0:4180}"
      OAUTH2_PROXY_REDIRECT_URL: "${OAUTH2_PROXY_REDIRECT_URL}"
      OAUTH2_PROXY_WHITELIST_DOMAINS: "${OAUTH2_PROXY_WHITELIST_DOMAINS}"
      OAUTH2_PROXY_EMAIL_DOMAINS: "${OAUTH2_PROXY_EMAIL_DOMAINS:-*}"
      OAUTH2_PROXY_UPSTREAMS: "${OAUTH2_PROXY_UPSTREAMS:-static://200}"
    labels:
      # --- Labels to expose oauth2-proxy's OWN endpoints ---
      - "traefik.enable=true"
      - "traefik.http.routers.oauth.rule=Host(`${OAUTH_HOST}`)"
      - "traefik.http.routers.oauth.entrypoints=${TRAEFIK_ENTRYPOINT:-websecure}"
      - "traefik.http.routers.oauth.tls.certresolver=${TRAEFIK_CERTRESOLVER}"
      - "traefik.http.routers.oauth.service=oauth"
      - "traefik.http.services.oauth.loadbalancer.server.port=${OAUTH2_PROXY_PORT:-4180}"

      # --- Forward Auth MIDDLEWARE ---
      - "traefik.http.middlewares.${MIDDLEWARE_NAME:-forward-auth}.forwardauth.address=http://${CONTAINER_NAME:-oauth2-proxy}:${OAUTH2_PROXY_PORT:-4180}/oauth2/auth"
      - "traefik.http.middlewares.${MIDDLEWARE_NAME:-forward-auth}.forwardauth.trustForwardHeader=true"
      - "traefik.http.middlewares.${MIDDLEWARE_NAME:-forward-auth}.forwardauth.authResponseHeaders=X-Forwarded-User,X-Forwarded-Email"
      - "traefik.http.middlewares.${MIDDLEWARE_NAME:-forward-auth}.forwardauth.authRequestHeaders=Cookie,X-Forwarded-For,X-Forwarded-Proto,X-Forwarded-Host"

      # --- Error Middleware for Auto-Redirect (Traefik v3 feature) ---
      - "traefik.http.middlewares.auth-errors.errors.status=401-403"
      - "traefik.http.middlewares.auth-errors.errors.service=auth-error-page@docker"
      - "traefik.http.middlewares.auth-errors.errors.query=/?url={url}"

  auth-error-page:
    image: ghcr.io/korjavin/oauth2-proxy-error-page:latest
    container_name: ${ERROR_PAGE_CONTAINER_NAME:-auth-error-page}
    restart: unless-stopped
    networks:
      - proxy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.auth-error-page.loadbalancer.server.port=80"

networks:
  proxy-network:
    external: true
    name: ${NETWORK_NAME:-traefik-net}
