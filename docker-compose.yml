version: '3.8'

services:
  oauth2-proxy:
    image: ${OAUTH2_PROXY_IMAGE:-quay.io/oauth2-proxy/oauth2-proxy:latest}
    container_name: ${CONTAINER_NAME:-oauth2-proxy}
    restart: unless-stopped
    networks:
      - proxy-network
    environment:
      # --- OIDC Provider Config ---
      OAUTH2_PROXY_PROVIDER: "${OAUTH2_PROXY_PROVIDER}"
      OAUTH2_PROXY_OIDC_ISSUER_URL: "${OAUTH2_PROXY_OIDC_ISSUER_URL}"

      # --- Client Credentials ---
      OAUTH2_PROXY_CLIENT_ID: "${OAUTH2_PROXY_CLIENT_ID}"
      OAUTH2_PROXY_CLIENT_SECRET: "${OAUTH2_PROXY_CLIENT_SECRET}"

      # --- Session & Cookie Config ---
      OAUTH2_PROXY_COOKIE_SECRET: "${OAUTH2_PROXY_COOKIE_SECRET}"
      OAUTH2_PROXY_COOKIE_DOMAIN: "${OAUTH2_PROXY_COOKIE_DOMAIN}"
      OAUTH2_PROXY_COOKIE_SECURE: "${OAUTH2_PROXY_COOKIE_SECURE:-true}"
      OAUTH2_PROXY_COOKIE_SAMESITE: "${OAUTH2_PROXY_COOKIE_SAMESITE:-strict}"

      # --- Proxy Config ---
      OAUTH2_PROXY_HTTP_ADDRESS: "${OAUTH2_PROXY_HTTP_ADDRESS:-0.0.0.0:4180}"
      OAUTH2_PROXY_REDIRECT_URL: "${OAUTH2_PROXY_REDIRECT_URL}"
      OAUTH2_PROXY_EMAIL_DOMAINS: "${OAUTH2_PROXY_EMAIL_DOMAINS:-*}"
      OAUTH2_PROXY_UPSTREAMS: "${OAUTH2_PROXY_UPSTREAMS:-static://200}"
    labels:
      # --- Labels to expose oauth2-proxy's OWN endpoints ---
      - "traefik.enable=true"
      - "traefik.http.routers.oauth.rule=Host(`${OAUTH_HOST}`)"
      - "traefik.http.routers.oauth.entrypoints=${TRAEFIK_ENTRYPOINT:-websecure}"
      - "traefik.http.routers.oauth.tls.certresolver=${TRAEFIK_CERTRESOLVER}"
      - "traefik.http.services.oauth.loadbalancer.server.port=${OAUTH2_PROXY_PORT:-4180}"

      # --- Forward Auth MIDDLEWARE ---
      - "traefik.http.middlewares.${MIDDLEWARE_NAME:-forward-auth}.forwardauth.address=http://${CONTAINER_NAME:-oauth2-proxy}:${OAUTH2_PROXY_PORT:-4180}/oauth2/auth"
      - "traefik.http.middlewares.${MIDDLEWARE_NAME:-forward-auth}.forwardauth.trustForwardHeader=true"
      - "traefik.http.middlewares.${MIDDLEWARE_NAME:-forward-auth}.forwardauth.authResponseHeaders=X-Forwarded-User, X-Forwarded-Email"

      # --- Error Page MIDDLEWARE ---
      - "traefik.http.middlewares.${ERROR_MIDDLEWARE_NAME:-auth-error-page}.errors.status=401,403"
      - "traefik.http.middlewares.${ERROR_MIDDLEWARE_NAME:-auth-error-page}.errors.service=oauth-signin"
      - "traefik.http.middlewares.${ERROR_MIDDLEWARE_NAME:-auth-error-page}.errors.query=/oauth2/sign_in?rd={scheme}://{host}{path}"

      # --- Internal service for error page ---
      - "traefik.http.services.oauth-signin.loadbalancer.server.port=${OAUTH2_PROXY_PORT:-4180}"

networks:
  proxy-network:
    external: true
    name: ${NETWORK_NAME:-traefik-net}
